<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salt Lake City Concert Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Salt Lake City Concert Finder</h1>
                <p class="text-sm sm:text-base text-gray-500 mt-1">Your guide to live music in the SLC area.</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Controls -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Filters -->
                        <div>
                            <label for="artistFilter" class="block text-sm font-medium text-gray-700">Filter by Artist</label>
                            <select id="artistFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All Artists</option>
                            </select>
                        </div>
                        <div>
                            <label for="venueFilter" class="block text-sm font-medium text-gray-700">Filter by Venue</label>
                            <select id="venueFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All Venues</option>
                            </select>
                        </div>
                        <div>
                            <label for="venueSizeFilter" class="block text-sm font-medium text-gray-700">Filter by Venue Size</label>
                            <select id="venueSizeFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All Sizes</option>
                            </select>
                        </div>
                        <div>
                            <label for="venueTypeFilter" class="block text-sm font-medium text-gray-700">Filter by Venue Type</label>
                            <select id="venueTypeFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All Types</option>
                            </select>
                        </div>
                         <!-- Date Range Filters -->
                        <div class="md:col-span-2 lg:col-span-2">
                             <label class="block text-sm font-medium text-gray-700">Filter by Date Range</label>
                             <div class="flex items-center space-x-2 mt-1">
                                <input type="date" id="startDate" class="block w-full border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <span class="text-gray-500">to</span>
                                <input type="date" id="endDate" class="block w-full border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                             </div>
                        </div>
                        <!-- Sorting -->
                        <div class="md:col-span-2 lg:col-span-2">
                            <label for="sort" class="block text-sm font-medium text-gray-700">Sort by</label>
                             <select id="sort" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="Show Date_asc">Date (Soonest First)</option>
                                <option value="Show Date_desc">Date (Latest First)</option>
                                <option value="Artist_asc">Artist (A-Z)</option>
                                <option value="Artist_desc">Artist (Z-A)</option>
                                <option value="Venue_asc">Venue (A-Z)</option>
                                <option value="Venue_desc">Venue (Z-A)</option>
                                <option value="Venue Size_asc">Venue Size (Smallest First)</option>
                                <option value="Venue Size_desc">Venue Size (Largest First)</option>
                                <option value="Venue Type_asc">Venue Type (A-Z)</option>
                                <option value="Venue Type_desc">Venue Type (Z-A)</option>
                            </select>
                        </div>
                    </div>
                     <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="showPast" name="showPast" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="showPast" class="font-medium text-gray-700">Show Past Concerts</label>
                            </div>
                        </div>
                        <button id="resetFilters" class="mt-4 sm:mt-0 w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Reset Filters
                        </button>
                    </div>
                </div>

                <!-- Concert List -->
                <div id="concertList" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    <!-- Concert cards will be injected here -->
                </div>
                 <div id="noResults" class="hidden text-center py-16">
                    <h3 class="text-lg font-medium text-gray-900">No concerts found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your filters.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // --- DATA FETCHING AND PREPARATION ---

        async function fetchData() {
            try {
                // --- MODIFIED: Use relative paths for GitHub Pages ---
                // Ensure the CSV files are in the same directory as this HTML file in your repository.
                const concertListUrl = 'Salt Lake City Area Concerts - Concert_List.csv';
                const venuesUrl = 'Salt Lake City Area Concerts - Venues.csv';

                // Fetch both CSV files concurrently
                const [concertsResponse, venuesResponse] = await Promise.all([
                    fetch(concertListUrl),
                    fetch(venuesUrl)
                ]);

                // Check if fetches were successful
                if (!concertsResponse.ok || !venuesResponse.ok) {
                    throw new Error('Failed to fetch concert data. Make sure the CSV files are in the same repository folder as the HTML file.');
                }

                // Get text content from responses
                const [concertsText, venuesText] = await Promise.all([
                    concertsResponse.text(),
                    venuesResponse.text()
                ]);

                // Parse the CSV text into arrays of objects
                const concerts = parseCSV(concertsText);
                const venues = parseCSV(venuesText);

                // Create a map of venues for easy lookup
                const venuesMap = new Map(venues.map(v => [v.Venue, v]));

                // Merge concert and venue data
                const mergedData = concerts.map(concert => {
                    const venueDetails = venuesMap.get(concert.Venue);
                    // Combine concert info with venue details
                    return { ...concert, ...venueDetails };
                });
                
                return mergedData;

            } catch (error) {
                console.error("Error fetching or processing data:", error);
                // Display an error message to the user on the page
                const concertList = document.getElementById('concertList');
                concertList.innerHTML = `<div class="col-span-full text-center py-16">
                    <h3 class="text-lg font-medium text-red-700">Error Loading Concerts</h3>
                    <p class="mt-1 text-sm text-red-500">${error.message}</p>
                </div>`;
                return []; // Return empty array on error
            }
        }

        // --- CSV PARSING UTILITY ---
        
        function parseCSV(text) {
             // --- MODIFIED: More robust line splitting ---
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            
            // Extract headers, trimming whitespace and removing quotes
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // This regex handles commas inside quoted fields
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (values.length === headers.length) {
                    const entry = {};
                    for (let j = 0; j < headers.length; j++) {
                        // Clean up the value by removing quotes and trimming whitespace
                        const value = values[j] ? values[j].trim().replace(/^"|"$/g, '') : '';
                        entry[headers[j]] = value;
                    }
                    data.push(entry);
                }
            }
            return data;
        }


        // --- DOM ELEMENTS ---

        const concertListElement = document.getElementById('concertList');
        const artistFilter = document.getElementById('artistFilter');
        const venueFilter = document.getElementById('venueFilter');
        const venueSizeFilter = document.getElementById('venueSizeFilter');
        const venueTypeFilter = document.getElementById('venueTypeFilter');
        const sortElement = document.getElementById('sort');
        const showPastCheckbox = document.getElementById('showPast');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const noResultsElement = document.getElementById('noResults');

        let allConcerts = [];

        // --- POPULATE FILTERS ---

        function populateFilters(concerts) {
            // Get unique values for each filter category, filtering out any empty/undefined values
            const artists = [...new Set(concerts.map(c => c.Artist).filter(Boolean))].sort();
            const venues = [...new Set(concerts.map(c => c.Venue).filter(Boolean))].sort();
            const venueSizes = [...new Set(concerts.map(c => c['Venue Size']).filter(Boolean))].sort((a,b) => a-b);
            const venueTypes = [...new Set(concerts.map(c => c['Venue Type']).filter(Boolean))].sort();

            // Populate artist dropdown
            artists.forEach(artist => {
                const option = document.createElement('option');
                option.value = artist;
                option.textContent = artist;
                artistFilter.appendChild(option);
            });
            // Populate venue dropdown
            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue;
                option.textContent = venue;
                venueFilter.appendChild(option);
            });
            // Populate venue size dropdown
            venueSizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                venueSizeFilter.appendChild(option);
            });
            // Populate venue type dropdown
            venueTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                venueTypeFilter.appendChild(option);
            });
        }
        
        // --- RENDERING LOGIC ---

        function renderConcerts(concerts) {
            concertListElement.innerHTML = ''; // Clear previous list

            if (concerts.length === 0) {
                noResultsElement.classList.remove('hidden');
            } else {
                noResultsElement.classList.add('hidden');
            }

            concerts.forEach(concert => {
                // Skip rendering if essential data is missing
                if (!concert.Artist || !concert['Show Date']) {
                    return;
                }
                
                // Create the main card container
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col fade-in';

                // Format the date for display, handle invalid dates gracefully
                const showDate = new Date(concert['Show Date']);
                 if (isNaN(showDate.getTime())) {
                    console.warn('Invalid date for concert:', concert);
                    return; // Skip rendering this card
                }
                const formattedDate = showDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: 'UTC' // Treat date as UTC to avoid timezone shift issues
                });

                // Card content
                card.innerHTML = `
                    <div class="p-5 flex-grow">
                        <p class="text-sm text-indigo-600 font-semibold">${formattedDate}</p>
                        <h2 class="text-xl font-bold text-gray-900 mt-1">${concert.Artist}</h2>
                        <p class="text-md text-gray-600">${concert['Show Title'] || ''}</p>
                        <p class="mt-2 text-sm text-gray-500">at <a href="${concert['Venue Page']}" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-800">${concert.Venue}</a></p>
                        
                        <div class="mt-3 flex flex-wrap gap-2">
                           <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${concert['Venue Type']}
                           </span>
                           <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Size: ${concert['Venue Size']}
                           </span>
                        </div>

                        <p class="mt-4 text-sm text-gray-700">${concert['Show Information'] || 'No additional information.'}</p>
                    </div>
                    <div class="p-5 bg-gray-50">
                        <a href="${concert['Ticket Purchase Page']}" target="_blank" class="block w-full text-center bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors duration-200">
                           Buy Tickets
                        </a>
                    </div>
                `;
                concertListElement.appendChild(card);
            });
        }
        
        // --- FILTERING AND SORTING LOGIC ---

        function applyFiltersAndSort() {
            let filteredConcerts = [...allConcerts];
            const now = new Date();
            now.setHours(0,0,0,0); // Set to beginning of today for accurate comparison

            // 1. Filter by "Show Past Concerts" checkbox
            if (!showPastCheckbox.checked) {
                filteredConcerts = filteredConcerts.filter(c => {
                    const showDate = new Date(c['Show Date']);
                    return !isNaN(showDate.getTime()) && showDate >= now;
                });
            }

            // 2. Filter by selected artist
            if (artistFilter.value !== 'All Artists') {
                filteredConcerts = filteredConcerts.filter(c => c.Artist === artistFilter.value);
            }

            // 3. Filter by selected venue
            if (venueFilter.value !== 'All Venues') {
                filteredConcerts = filteredConcerts.filter(c => c.Venue === venueFilter.value);
            }
            
            // 4. Filter by venue size
            if (venueSizeFilter.value !== 'All Sizes') {
                filteredConcerts = filteredConcerts.filter(c => c['Venue Size'] === venueSizeFilter.value);
            }

            // 5. Filter by venue type
            if (venueTypeFilter.value !== 'All Types') {
                filteredConcerts = filteredConcerts.filter(c => c['Venue Type'] === venueTypeFilter.value);
            }

            // 6. Filter by date range
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            if (startDate) {
                 // Adjust start date to the beginning of the day (in UTC)
                startDate.setUTCHours(0, 0, 0, 0);
                filteredConcerts = filteredConcerts.filter(c => new Date(c['Show Date']) >= startDate);
            }
            if (endDate) {
                 // Adjust end date to the end of the day (in UTC)
                endDate.setUTCHours(23, 59, 59, 999);
                filteredConcerts = filteredConcerts.filter(c => new Date(c['Show Date']) <= endDate);
            }
            
            // 7. Sort the results
            const [sortKey, sortOrder] = sortElement.value.split('_');
            filteredConcerts.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                // Special handling for date and numeric sorting
                if (sortKey === 'Show Date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else if (sortKey === 'Venue Size') {
                     valA = parseInt(valA, 10) || 0;
                     valB = parseInt(valB, 10) || 0;
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                // Comparison logic
                if (valA < valB) {
                    return sortOrder === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return sortOrder === 'asc' ? 1 : -1;
                }
                return 0;
            });

            renderConcerts(filteredConcerts);
        }

        // --- INITIALIZATION AND EVENT LISTENERS ---

        async function initializeApp() {
            // Display a loading indicator
            concertListElement.innerHTML = '<p class="col-span-full text-center py-16 text-gray-500">Loading concerts...</p>';
            
            // Fetch and process data
            allConcerts = await fetchData();

            if(allConcerts.length > 0) {
              // Populate filter dropdowns with available options
              populateFilters(allConcerts);
              // Apply default filters and sorting
              applyFiltersAndSort();
            }

            // Attach event listeners to all controls
            [artistFilter, venueFilter, venueSizeFilter, venueTypeFilter, sortElement, showPastCheckbox, startDateInput, endDateInput].forEach(el => {
                el.addEventListener('change', applyFiltersAndSort);
            });
            
            // Event listener for the reset button
            resetFiltersBtn.addEventListener('click', () => {
                artistFilter.value = 'All Artists';
                venueFilter.value = 'All Venues';
                venueSizeFilter.value = 'All Sizes';
                venueTypeFilter.value = 'All Types';
                sortElement.value = 'Show Date_asc';
                showPastCheckbox.checked = false;
                startDateInput.value = '';
                endDateInput.value = '';
                applyFiltersAndSort();
            });
        }

        // Start the application
        initializeApp();

    </script>
</body>
</html>
